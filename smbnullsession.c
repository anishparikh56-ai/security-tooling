// smbnull.c - Ultra-fast SMB Null Session Checker in C
// Compile: gcc -o smbnull smbnull.c
// Usage:   ./smbnull 10.10.10.50
//          ./smbnull 192.168.1.0/24

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netdb.h>

unsigned char smb_negotiate[] = {
    0x00, 0x00, 0x00, 0x85, 0xff, 0x53, 0x4d, 0x42, 0x72, 0x00, 0x00, 0x00, 0x00, 0x18,
    0x53, 0xc8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6c, 0x00, 0x02,
    0x50, 0x43, 0x20, 0x4e, 0x45, 0x54, 0x57, 0x4f, 0x52, 0x4b, 0x20, 0x50, 0x52, 0x4f,
    0x47, 0x52, 0x41, 0x4d, 0x20, 0x31, 0x2e, 0x30, 0x00, 0x02, 0x4c, 0x41, 0x4e, 0x4d,
    0x41, 0x4e, 0x31, 0x2e, 0x30, 0x00, 0x02, 0x57, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x73,
    0x20, 0x66, 0x6f, 0x72, 0x20, 0x57, 0x6f, 0x72, 0x6b, 0x67, 0x72, 0x6f, 0x75, 0x70,
    0x73, 0x20, 0x33, 0x2e, 0x31, 0x61, 0x00, 0x02, 0x4c, 0x4d, 0x31, 0x2e, 0x32, 0x58,
    0x30, 0x30, 0x32, 0x00, 0x02, 0x4c, 0x41, 0x4e, 0x4d, 0x41, 0x4e, 0x32, 0x2e, 0x31,
    0x00, 0x02, 0x4e, 0x54, 0x20, 0x4c, 0x4d, 0x20, 0x30, 0x2e, 0x31, 0x32, 0x00
};

unsigned char smb_session_setup[] = {
    0x00, 0x00, 0x00, 0x63, 0xff, 0x53, 0x4d, 0x42, 0x73, 0x00, 0x00, 0x00, 0x00, 0x18,
    0x01, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x0c, 0xff, 0x00, 0x00,
    0x00, 0xff, 0xff, 0x02, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x2a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x22, 0x00, 0x02, 0x4e,
    0x54, 0x4c, 0x4d, 0x53, 0x53, 0x50, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x82, 0x88,
    0xa2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x57, 0x00, 0x69, 0x00, 0x6e, 0x00, 0x64, 0x00, 0x6f,
    0x00, 0x77, 0x00, 0x73, 0x00, 0x00, 0x00
};

int smb_connect(const char *ip) {
    int sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0) return -1;

    struct sockaddr_in server = {0};
    server.sin_family = AF_INET;
    server.sin_port = htons(445);
    inet_pton(AF_INET, ip, &server.sin_addr);

    if (connect(sock, (struct sockaddr*)&server, sizeof(server)) < 0) {
        close(sock);
        return -1;
    }

    send(sock, smb_negotiate, sizeof(smb_negotiate), 0);
    char resp[1024];
    recv(sock, resp, sizeof(resp), 0);

    send(sock, smb_session_setup, sizeof(smb_session_setup), 0);
    int n = recv(sock, resp, sizeof(resp), 0);

    close(sock);
    return (n > 10 && memcmp(resp+9, "\x00\x00\x00\x00", 4) == 0) ? 1 : 0;
}

void enum_shares(const char *ip) {
    printf("\033[1;32m[+] NULL SESSION SUCCESS → %s\033[0m\n", ip);
    printf("    Trying common shares...\n");

    const char *shares[] = {"C$", "ADMIN$", "IPC$", "print$", "NETLOGON", "SYSVOL", NULL};
    for (int i = 0; shares[i]; i++) {
        char cmd[256];
        snprintf(cmd, sizeof(cmd), "smbclient -N -L //%s/%s 2>/dev/null | grep -i disk", ip, shares[i]);
        if (system(cmd) == 0) {
            printf("      → %s is readable!\n", shares[i]);
        }
    }
}

int main(int argc, char **argv) {
    if (argc != 2) {
        printf("SMB Null Session Checker (2025) – pure C, no deps\n");
        printf("Usage: %s <ip> or <cidr>\n", argv[0]);
        printf("   ./smbnull 10.11.1.50\n");
        printf("   ./smbnull 192.168.1.0/24\n");
        return 1;
    }

    if (strchr(argv[1], '/')) {
        // CIDR scan mode
        char base[16], *p = strdup(argv[1]);
        int bits = 24;
        sscanf(p, "%15[^/]/%d", base, &bits);
        unsigned long net = ntohl(inet_addr(base));
        unsigned long mask = 0xFFFFFFFF << (32 - bits);
        unsigned long start = (net & mask) + 1;
        unsigned long end = net | ~mask;

        printf("[*] Scanning %s (%ld hosts)...\n", argv[1], end - start);

        for (unsigned long ip = start; ip < end; ip++) {
            char target[16];
            struct in_addr a = { htonl(ip) };
            strcpy(target, inet_ntoa(a));
            if (smb_connect(target)) {
                enum_shares(target);
            }
        }
    } else {
        if (smb_connect(argv[1])) {
            enum_shares(argv[1]);
        } else {
            printf("\033[1;31m[-] %s → Null session blocked\033[0m\n", argv[1]);
        }
    }

    return 0;
}
